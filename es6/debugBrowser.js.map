{"version":3,"sources":["../src/debugBrowser.js"],"names":["sleep","ms","Promise","res","setTimeout","process","on","reason","console","log","exit","exited","DEV_URL","DebugApps","constructor","sessions","render","urls","getSessions","browser","pages","index","url","entries","newPage","page","all","waitForNavigation","timeout","waitUntil","goto","evaluate","x","document","getElementById","click","setSessions","next","start","launch","headless","args","slice","map","setInterval","getDevUrl","port","id","firstAnswer","rest","get","json","length","webSocketDebuggerUrl","replace","err"],"mappings":"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","file":"debugBrowser.js","sourcesContent":["import r2 from '@mcro/r2'\nimport puppeteer from 'puppeteer'\n\nconst sleep = ms => new Promise(res => setTimeout(res, ms))\n\nprocess.on('unhandledRejection', function(reason) {\n  console.log(reason)\n  process.exit(0)\n})\n\nlet exited = false\nprocess.on('beforeExit', () => {\n  exited = true\n})\n\nconst DEV_URL =\n  'chrome-devtools://devtools/bundled/inspector.html?experiments=true&v8only=true&ws='\n\nexport default class DebugApps {\n  constructor({ sessions = [] }) {\n    this.sessions = sessions\n    this.urls = []\n  }\n\n  setSessions(next) {\n    this.sessions = next\n    this.render()\n  }\n\n  async start() {\n    this.browser = await puppeteer.launch({\n      headless: false,\n      args: [`--window-size=${800},${600}`],\n    })\n    // one less because it starts with a tab already open\n    await Promise.all(this.sessions.slice(1).map(() => this.browser.newPage()))\n    setInterval(this.render, 500)\n  }\n\n  async getSessions() {\n    return await Promise.all(this.sessions.map(this.getDevUrl))\n  }\n\n  async getDevUrl({ port, id }) {\n    const url = `http://127.0.0.1:${port}/${id ? `${id}/` : ''}json`\n    try {\n      const [firstAnswer, ...rest] = await r2.get(url).json\n      if (rest.length) console.log('rest', rest)\n      const { webSocketDebuggerUrl } = firstAnswer\n      if (!webSocketDebuggerUrl) {\n        return null\n      }\n      return `${DEV_URL}/${webSocketDebuggerUrl.replace(`ws://`, '')}`\n    } catch (err) {\n      console.log('error fetching', url)\n      return null\n    }\n  }\n\n  render = async () => {\n    if (exited) return\n    const urls = await this.getSessions()\n    if (!this.browser) {\n      console.log('error no browser wierd')\n      return\n    }\n    let pages = await this.browser.pages()\n    if (!pages) {\n      console.log('Error DebugBrowser.render: no pages')\n      return\n    }\n    for (const [index, url] of urls.entries()) {\n      if (this.urls[index] === url) {\n        continue\n      }\n      this.urls[index] = url\n      if (!url) continue\n      if (!pages[index]) {\n        await this.browser.newPage()\n        await sleep(20)\n        pages = await this.browser.pages()\n        if (!pages) {\n          console.log('weird no pages............')\n          return\n        }\n      }\n      const page = pages[index]\n      await Promise.all([\n        page.waitForNavigation({\n          timeout: 5000,\n          waitUntil: 'domcontentloaded',\n        }),\n        page.goto(url),\n      ])\n      await page.evaluate(() => {\n        // open console\n        let x = document.getElementById('tab-console')\n        if (x) x.click()\n        else {\n          console.log('no element')\n        }\n      })\n    }\n  }\n}\n"]}